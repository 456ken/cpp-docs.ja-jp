---
title: ガイド付き最適化のプロファイル
ms.date: 03/14/2018
helpviewer_keywords:
- profile-guided optimizations
- optimization, profile-guided [C++]
ms.assetid: 2225c307-d3ae-42c1-8345-a5a959d132dc
ms.openlocfilehash: f4e9af0b2e08dfa4082ebe71caf788ed1188ab7b
ms.sourcegitcommit: 8105b7003b89b73b4359644ff4281e1595352dda
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/14/2019
ms.locfileid: "57827041"
---
# <a name="profile-guided-optimizations"></a>ガイド付き最適化のプロファイル

ガイド付き最適化のプロファイルによって出力ファイルを最適化できます。この場合、オプティマイザーは .exe ファイルまたは .dll ファイルのテスト実行データを使用します。 このデータは、稼働環境でのプログラムの実行動作を示します。

プロファイル ガイド付き最適化の x86 または x64 のネイティブ ターゲットにのみ利用できます。 プロファイル ガイド付き最適化のでは、共通言語ランタイムで実行される出力ファイルを使用できません。 ネイティブおよびマネージの混合コードとアセンブリを生成した場合でも (を使用して、 **/clr**コンパイラ オプション)、ネイティブ コードのみプロファイル ガイド付き最適化を使用することはできません。 IDE で設定するこれらのオプションでプロジェクトをビルドしようとした場合、ビルド エラーが発生します。

> [!NOTE]
> プロファイリングのテスト実行から収集される情報にはそれ以外の場合に効果を指定する場合の最適化よりも優先されます **/Ob**、 **/Os**、または **/Ot**します。 詳細については、次を参照してください。 [/Ob (関数のインライン展開)](reference/ob-inline-function-expansion.md)と[/Os、/Ot (実行速度の優先、優先する高速コード)](reference/os-ot-favor-small-code-favor-fast-code.md)します。

## <a name="steps-to-optimize-your-app"></a>アプリを最適化する手順

プロファイル ガイド付き最適化を使用するには、アプリを最適化するために次の手順に従います。

- 1 つまたは複数のソース コード ファイルをコンパイル[/GL](reference/gl-whole-program-optimization.md)します。

   各モジュールで構築された **/GL**プロファイル ガイド付き最適化の実行時の動作をキャプチャするテストの実行中に調べることができます。 プロファイル ガイド付き最適化のビルドのすべてのモジュールを使用してコンパイルする必要はありません **/GL**します。 これらのモジュールがコンパイルただし、 **/GL**プロファイル ガイド付き最適化をインストルメント化され、後で使用できます。

- 使用してリンク[/LTCG](reference/ltcg-link-time-code-generation.md)と[/GENPROFILE または/FASTGENPROFILE](reference/genprofile-fastgenprofile-generate-profiling-instrumented-build.md)します。

   両方を使用して **/LTCG**と **/GENPROFILE**または **/FASTGENPROFILE**インストルメント化されたアプリの実行時に .pgd ファイルを作成します。 テスト実行データが追加された .pgd ファイルは、次のリンク ステップ (最適化イメージの作成) での入力として使用できます。 指定するときに **/GENPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または .pgd ファイルの場所を指定する引数。 組み合わせた **/LTCG**と **/GENPROFILE**または **/FASTGENPROFILE**リンカー オプションは非推奨とされる置換 **/LTCG:PGINSTRUMENT**リンカー オプション。

- アプリケーションのプロファイリングを行います。

   各時間のプロファイリングされた EXE セッションが終了またはプロファイリングされた DLL がアンロードされて、 *appname*! # .pgc ファイルが作成されます。 .pgc ファイルには、特定のアプリケーションのテスト実行情報が含まれます。 # は番号にインクリメントされるその他の数に基づいて 1 から始まる*appname*!!#.pgc ファイル ディレクトリにします。 テスト実行の結果が目的の最適化のシナリオを示さない場合は、.pgc ファイルを削除できます。

   テストの実行中に現在開いている .pgc ファイルのクロージャと新しい .pgc ファイルの作成を強制することができます、 [pgosweep](pgosweep.md) (たとえば、テスト シナリオの最後は、アプリケーションのシャット ダウンと一致しない) 場合は、ユーティリティ。

   アプリケーションは直接呼び出すことも、PGO 関数[PgoAutoSweep](pgoautosweep.md)、.pgc ファイルとして呼び出しの時点のプロファイル データをキャプチャします。 .Pgc ファイルにキャプチャされたデータを対象となるコードをより細かく制御が与えることができます。 この関数を使用する方法の例は、次を参照してください。、 [PgoAutoSweep](pgoautosweep.md)ドキュメント。

   既定では、インストルメント化されたビルドを作成するときに、データ コレクションがスレッド セーフ モードでは高速ですが、完全に正確なことができない可能性がありますで実行されます。 使用して、 **EXACT**引数 **/GENPROFILE**または **/FASTGENPROFILE**は遅くなりますより正確なスレッド セーフ モードでデータ コレクションを指定することができます。 このオプションは非推奨に設定した場合でも[PogoSafeMode](environment-variables-for-profile-guided-optimizations.md#pogosafemode)環境変数、または非推奨とされる **/POGOSAFEMODE**リンカー オプション、インストルメント化されたビルドを作成するときにします。

- 使用してリンク **/LTCG**と **/USEPROFILE**します。

   両方を使用して、 **/LTCG**と[/USEPROFILE](reference/useprofile.md)最適化されたイメージを作成するためのリンカー オプション。 このステップでは、.pgd ファイルを入力として使用します。 指定すると **/USEPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または .pgd ファイルの場所を指定する引数。 非推奨を使用してこの名前を指定することもできます。 **/PGD**リンカー オプション。 組み合わせた **/LTCG**と **/USEPROFILE** 、非推奨が置き換えられます **/LTCG:PGOPTIMIZE**と **/LTCG:PGUPDATE**リンカー オプション。

最適化された出力ファイルを作成し、追加のプロファイリングによりさらに最適化されたイメージを作成できるかどうかを後で判断することもできます。 インストルメント化されたイメージとその .pgd ファイルが使用可能な場合は、追加のテストの実行を行うしより新しい .pgd ファイルで同じを使用して、最適化されたイメージを再構築 **/LTCG**と **/USEPROFILE**リンカー オプション.

## <a name="optimizations-performed-by-pgo"></a>PGO によって実行される最適化

ガイド付き最適化のプロファイルの一覧を次に示します。

- **インライン展開**- たとえば、関数、関数の B を頻繁に呼び出すことと関数 B が、比較的小さなですし、プロファイル ガイド付き最適化の関数 A. でインライン関数 B が存在します

- **仮想呼び出し推理**-仮想呼び出し、またはその他の呼び出し、関数ポインターを通じて特定の関数の対象が頻繁に場合、プロファイル ガイド付き最適化は、多くの場合を対象とした関数に条件付きで実行される直接呼び出しを挿入できます直接の呼び出しをインライン展開できます。

- **レジスタ割り当て**- より優れたレジスタ割り当てのプロファイル データの結果を最適化します。

- **基本ブロックの最適化**-基本ブロックの最適化により、同じ一連のページ (ローカリティ) に配置するのには特定のフレーム内で一時的に実行される一般的な実行の基本的な要素です。 これにより使用されるページ数が最小限に抑えられ、メモリのオーバーヘッドが最小限になります。

- **サイズ/速度の最適化**-プログラムが多くの時間を費やす関数の速度を最適化できます。

- **関数のレイアウト**- 呼び出し先に基づいており、呼び出し元/呼び出し先の動作、プロファイリングの対象となる傾向があります、同じ実行パスを関数内の同じセクションに配置します。

- **条件付き分岐の最適化**-プロファイル ガイド付きの値プローブを使用して、最適化が switch ステートメントで指定した値が他の値よりも頻繁に使用されるかどうかを検索することができます。  この値は switch ステートメントから取得できます。  また、if ブロックまたは else ブロックのどちらがより頻繁に true になるかに応じて、このどちらかのブロックを最初に置くようにオプティマイザーが if/else を並べ替えることができる場合には、これと同じことを if/else 命令でも行うことができます。

- **実行されないコード分離**-プロファイリング中に呼び出されていないコード、一連のセクションの末尾に追加した特別なセクションに移動します。 これにより、頻繁に使用されるページからこのセクションが切り離されます。

- **EH コード分離付き**-プロファイル ガイド付き最適化が、例外が例外的な状況でのみ実行することを確認することができる場合は的に実行される EH コード別のセクションに移動することは多くの場合。

- **メモリの組み込み**の組み込みが頻繁に呼び出される場合を判断できる場合、組み込みの拡張をより決定できます。 また、組み込みは、移動またはコピーのブロック サイズに基づいて最適化することもできます。

Visual Studio 2013 を使用する場合、自動使える[プロファイル ガイド付き最適化のプラグイン](profile-guided-optimization-in-the-performance-and-diagnostics-hub.md)を簡略化し、Visual Studio 内の最適化プロセスを効率化のパフォーマンスと診断ハブでの Visual C。 このプラグインは以降のバージョンの Visual Studio で使用できるではありません。

## <a name="next-steps"></a>次の手順

これらの環境変数、関数、およびツールについてもっと読むプロファイル ガイド付き最適化に使用できます。

[ガイド付き最適化のプロファイルの環境変数](environment-variables-for-profile-guided-optimizations.md)<br/>
これらの変数は、テスト シナリオの実行時の動作を指定できます。 新しいリンカー オプションを優先して使用されなくなっていますこの環境変数からリンカー オプションに移動するためにテキストを読み取る。

[PgoAutoSweep](pgoautosweep.md)<br/>
関数の細かい .pgc ファイル データのキャプチャの制御を提供するアプリに追加することができます。

[pgosweep](pgosweep.md)<br/>
.Pgc ファイルをすべてのプロファイル データを書き込むコマンド ライン ユーティリティは、.pgc ファイルを閉じます、新しい .pgc ファイルを開きます。

[pgomgr](pgomgr.md)<br/>
.Pgd ファイルを 1 つまたは複数の .pgc ファイルからプロファイル データを追加するコマンド ライン ユーティリティです。

[方法: 複数の PGO プロファイルを単一のプロファイルにマージする](how-to-merge-multiple-pgo-profiles-into-a-single-profile.md)<br/>
例の**pgomgr**使用量。

## <a name="see-also"></a>関連項目

[追加の MSVC ビルド ツール](reference/c-cpp-build-tools.md)
